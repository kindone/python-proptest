
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Python Property-Based Testing Library">
      
      
        <meta name="author" content="kindone">
      
      
        <link rel="canonical" href="https://kindone.github.io/python-proptest/stateful-testing/">
      
      
        <link rel="prev" href="../shrinking/">
      
      
        <link rel="next" href="../pytest-integration/">
      
      
      <link rel="icon" href="../assets/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.22">
    
    
      
        <title>Stateful Testing - python-proptest</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.84d31ad4.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CSpline+Sans+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"Spline Sans Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="teal" data-md-color-accent="light-green">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#stateful-testing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="python-proptest" class="md-header__button md-logo" aria-label="python-proptest" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            python-proptest
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Stateful Testing
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/kindone/python-proptest" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    kindone/python-proptest
  </div>
</a>
      </div>
    
  </nav>
  
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="python-proptest" class="md-nav__button md-logo" aria-label="python-proptest" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    python-proptest
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kindone/python-proptest" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    kindone/python-proptest
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Introduction
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../generators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Generators
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../combinators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Combinators
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../properties/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Properties
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../decorators/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Decorators
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../shrinking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Shrinking
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Stateful Testing
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Stateful Testing
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-stateful-property" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Stateful Property
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-stateful-testing-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Stateful Testing Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Stateful Testing Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-a-stack-data-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Testing a Stack Data Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-a-bank-account-with-model" class="md-nav__link">
    <span class="md-ellipsis">
      Testing a Bank Account with Model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shrinking-in-stateful-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Shrinking in Stateful Testing
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../pytest-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pytest Integration
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../unittest-integration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Unittest Integration
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../pytest-best-practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Pytest Best Practices
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      Core Concepts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-a-stateful-property" class="md-nav__link">
    <span class="md-ellipsis">
      Creating a Stateful Property
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#advanced-stateful-testing-examples" class="md-nav__link">
    <span class="md-ellipsis">
      Advanced Stateful Testing Examples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Advanced Stateful Testing Examples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#testing-a-stack-data-structure" class="md-nav__link">
    <span class="md-ellipsis">
      Testing a Stack Data Structure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#testing-a-bank-account-with-model" class="md-nav__link">
    <span class="md-ellipsis">
      Testing a Bank Account with Model
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#shrinking-in-stateful-testing" class="md-nav__link">
    <span class="md-ellipsis">
      Shrinking in Stateful Testing
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="stateful-testing">Stateful Testing<a class="headerlink" href="#stateful-testing" title="Permanent link">&para;</a></h1>
<p>Stateful testing involves defining a sequence of actions or commands that can be applied to a system under test and verifying properties or invariants about the system's state after executing these sequences.</p>
<p><code>python-proptest</code> provides utilities for defining state machines and generating sequences of commands to effectively test stateful systems. It allows you to model the state of your system, define actions that change the state, and automatically run sequences of these actions to find bugs.</p>
<h2 id="core-concepts">Core Concepts<a class="headerlink" href="#core-concepts" title="Permanent link">&para;</a></h2>
<p>Stateful testing in <code>python-proptest</code> revolves around the <code>StatefulProperty</code> class, which orchestrates the test execution. Here are the key components:</p>
<ol>
<li><strong>Initial State (<code>ObjectType</code>)</strong>: You need a generator (<code>Generator[ObjectType]</code>) that produces the initial state of the system under test for each test run.</li>
<li><strong>Actions (<code>Action</code> or <code>SimpleAction</code>)</strong>: Actions represent operations that modify the system's state.<ul>
<li><code>SimpleAction</code>: Used when you don't need an explicit model. It takes a function <code>(obj: ObjectType) -&gt; None</code>.</li>
<li><code>Action</code>: Used when you have a model. It takes a function <code>(obj: ObjectType, model: ModelType) -&gt; None</code> and updates both the real object and the model.</li>
</ul>
</li>
<li><strong>Model (<code>ModelType</code>, Optional)</strong>: A simplified representation of the system's state. It's used to verify the correctness of the actual system's state after each action.</li>
<li><strong>Model Factory (<code>model_factory</code>, Optional)</strong>: A function <code>(obj: ObjectType) -&gt; ModelType</code> that creates the initial model state based on the initial object state. Required if using a model.</li>
<li><strong>Action Generation (<code>action_gen_factory</code> or <code>simple_action_gen_factory</code>)</strong>: A factory function that returns a generator for the <em>next</em> action based on the <em>current</em> state of the object (and model, if applicable).<ul>
<li><code>SimpleActionGenFactory</code>: <code>(obj: ObjectType) -&gt; Generator[SimpleAction[ObjectType]]</code></li>
<li><code>ActionGenFactory</code>: <code>(obj: ObjectType, model: ModelType) -&gt; Generator[Action[ObjectType, ModelType]]</code>
<code>python-proptest</code> provides helpers like <code>simple_action_gen_of</code> and <code>action_gen_of</code> to combine multiple action generators.</li>
</ul>
</li>
</ol>
<h2 id="creating-a-stateful-property">Creating a Stateful Property<a class="headerlink" href="#creating-a-stateful-property" title="Permanent link">&para;</a></h2>
<p>You typically use factory functions to create a <code>StatefulProperty</code>:</p>
<ul>
<li>
<p><strong><code>simple_stateful_property&lt;ObjectType&gt;(initial_gen, simple_action_gen_factory)</code></strong>: Use this when you don't need an explicit model. Checks are usually performed within the <code>SimpleAction</code> implementations (e.g., asserting invariants after an operation).</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python_proptest</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gen</span><span class="p">,</span> <span class="n">simple_stateful_property</span><span class="p">,</span> <span class="n">SimpleAction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="c1"># Define the system type</span>
<span class="n">MySystem</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

<span class="c1"># Generator for the initial state (e.g., an empty list)</span>
<span class="n">initial_gen</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">([])</span>

<span class="c1"># Action: Add an element</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_action_gen</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span>
        <span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
    <span class="p">)</span>

<span class="c1"># Action: Clear the list</span>
<span class="k">def</span><span class="w"> </span><span class="nf">clear_action_gen</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span>
        <span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">arr</span><span class="o">.</span><span class="n">clear</span><span class="p">())</span>
    <span class="p">)</span>

<span class="c1"># Combine action generators</span>
<span class="k">def</span><span class="w"> </span><span class="nf">action_factory</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">MySystem</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">add_action_gen</span><span class="p">(),</span> <span class="n">clear_action_gen</span><span class="p">())</span>

<span class="c1"># Create the property</span>
<span class="n">prop</span> <span class="o">=</span> <span class="n">simple_stateful_property</span><span class="p">(</span><span class="n">initial_gen</span><span class="p">,</span> <span class="n">action_factory</span><span class="p">)</span>

<span class="c1"># Run the test</span>
<span class="n">prop</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
</code></pre></div>
</li>
<li>
<p><strong><code>stateful_property&lt;ObjectType, ModelType&gt;(initial_gen, model_factory, action_gen_factory)</code></strong>: Use this when you want to maintain a separate model to verify the system's behavior against.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python_proptest</span><span class="w"> </span><span class="kn">import</span> <span class="n">Gen</span><span class="p">,</span> <span class="n">stateful_property</span><span class="p">,</span> <span class="n">Action</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="c1"># Define the system and model types</span>
<span class="n">MySystem</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
<span class="n">MyModel</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span>  <span class="c1"># Simplified model: {&quot;count&quot;: int}</span>

<span class="c1"># Initial state generator</span>
<span class="n">initial_gen</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">list</span><span class="p">(</span><span class="n">Gen</span><span class="o">.</span><span class="n">int</span><span class="p">(),</span> <span class="n">min_length</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Model factory</span>
<span class="k">def</span><span class="w"> </span><span class="nf">model_factory</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">MySystem</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">MyModel</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">)}</span>

<span class="c1"># Action: Add element (updates object and model)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_action_gen</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span>
        <span class="n">Action</span><span class="p">(</span><span class="k">lambda</span> <span class="n">arr</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">),</span>
            <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">})</span>
        <span class="p">))</span>
    <span class="p">)</span>

<span class="c1"># Action: Remove element (updates object and model)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">remove_action_gen</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span>
        <span class="n">Action</span><span class="p">(</span><span class="k">lambda</span> <span class="n">arr</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="p">(</span>
            <span class="n">arr</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">arr</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)})</span> <span class="k">if</span> <span class="n">arr</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="p">))</span>
    <span class="p">)</span>

<span class="c1"># Action generator factory</span>
<span class="k">def</span><span class="w"> </span><span class="nf">action_factory</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">MySystem</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">MyModel</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">add_action_gen</span><span class="p">(),</span> <span class="n">remove_action_gen</span><span class="p">())</span>

<span class="c1"># Create the property</span>
<span class="n">prop</span> <span class="o">=</span> <span class="n">stateful_property</span><span class="p">(</span><span class="n">initial_gen</span><span class="p">,</span> <span class="n">model_factory</span><span class="p">,</span> <span class="n">action_factory</span><span class="p">)</span>

<span class="c1"># Run the test</span>
<span class="n">prop</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
</code></pre></div>
</li>
</ul>
<h2 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h2>
<p>The <code>StatefulProperty</code> instance provides several methods for configuration:</p>
<ul>
<li><code>set_seed(seed)</code>: Sets the initial seed for the random number generator for reproducible tests.</li>
<li><code>set_num_runs(num_runs)</code>: Sets the number of test sequences to execute (default: 100).</li>
<li><code>set_min_actions(min_actions)</code> / <code>set_max_actions(max_actions)</code>: Sets the minimum and maximum number of actions per sequence (default: 1-100).</li>
<li><code>set_verbosity(verbose)</code>: Enables/disables verbose logging during execution.</li>
<li><code>set_on_startup(startup_func)</code>: Sets a function to run before each test sequence.</li>
<li><code>set_on_cleanup(cleanup_func)</code>: Sets a function to run after each successful test sequence.</li>
<li><code>set_post_check(post_check_func)</code>: Sets a function to run after all actions in a sequence have completed successfully. Useful for final state validation. You can also use <code>set_post_check_without_model((obj: ObjectType) -&gt; None)</code>.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python_proptest</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_stateful_property</span><span class="p">,</span> <span class="n">Gen</span><span class="p">,</span> <span class="n">SimpleAction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_configured_stateful_property</span><span class="p">():</span>
    <span class="c1"># Define a simple counter system</span>
    <span class="n">Counter</span> <span class="o">=</span> <span class="nb">int</span>

    <span class="c1"># Initial state</span>
    <span class="n">initial_gen</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Actions</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">increment_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">counter</span><span class="p">:</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrement_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">counter</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">action_factory</span><span class="p">(</span><span class="n">counter</span><span class="p">:</span> <span class="n">Counter</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">increment_action</span><span class="p">(),</span> <span class="n">decrement_action</span><span class="p">())</span>

    <span class="c1"># Create and configure the property</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">simple_stateful_property</span><span class="p">(</span><span class="n">initial_gen</span><span class="p">,</span> <span class="n">action_factory</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>  <span class="c1"># Reproducible tests</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_num_runs</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  <span class="c1"># Fewer runs for faster testing</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_min_actions</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># At least 5 actions per sequence</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_max_actions</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>  <span class="c1"># At most 20 actions per sequence</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># Enable verbose output</span>

    <span class="c1"># Add startup and cleanup functions</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_on_startup</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Starting test sequence&quot;</span><span class="p">))</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_on_cleanup</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test sequence completed&quot;</span><span class="p">))</span>

    <span class="c1"># Add post-check to verify final state</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_post_check_without_model</span><span class="p">(</span><span class="k">lambda</span> <span class="n">counter</span><span class="p">:</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Run the test</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
</code></pre></div>
<h2 id="advanced-stateful-testing-examples">Advanced Stateful Testing Examples<a class="headerlink" href="#advanced-stateful-testing-examples" title="Permanent link">&para;</a></h2>
<h3 id="testing-a-stack-data-structure">Testing a Stack Data Structure<a class="headerlink" href="#testing-a-stack-data-structure" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python_proptest</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_stateful_property</span><span class="p">,</span> <span class="n">Gen</span><span class="p">,</span> <span class="n">SimpleAction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_stack_implementation</span><span class="p">():</span>
    <span class="c1"># Define the stack system</span>
    <span class="n">Stack</span> <span class="o">=</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>

    <span class="c1"># Initial state: empty stack</span>
    <span class="n">initial_gen</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">([])</span>

    <span class="c1"># Action: Push an element</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">push_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">int</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span>
            <span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stack</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="c1"># Action: Pop an element</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">pop_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span>
            <span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stack</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span> <span class="k">if</span> <span class="n">stack</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Action: Peek at the top element</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">peek_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span>
            <span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stack</span><span class="p">:</span> <span class="n">stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">stack</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="c1"># Action generator factory</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_factory</span><span class="p">(</span><span class="n">stack</span><span class="p">:</span> <span class="n">Stack</span><span class="p">):</span>
        <span class="c1"># Only allow pop/peek if stack is not empty</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">push_action</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">push_action</span><span class="p">(),</span> <span class="n">pop_action</span><span class="p">(),</span> <span class="n">peek_action</span><span class="p">())</span>

    <span class="c1"># Create the property</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">simple_stateful_property</span><span class="p">(</span><span class="n">initial_gen</span><span class="p">,</span> <span class="n">action_factory</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_post_check_without_model</span><span class="p">(</span><span class="k">lambda</span> <span class="n">stack</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">stack</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># Run the test</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
</code></pre></div>
<h3 id="testing-a-bank-account-with-model">Testing a Bank Account with Model<a class="headerlink" href="#testing-a-bank-account-with-model" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python_proptest</span><span class="w"> </span><span class="kn">import</span> <span class="n">stateful_property</span><span class="p">,</span> <span class="n">Gen</span><span class="p">,</span> <span class="n">Action</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_bank_account</span><span class="p">():</span>
    <span class="c1"># Define the system and model types</span>
    <span class="n">BankAccount</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {&quot;balance&quot;: float, &quot;transactions&quot;: List[float]}</span>
    <span class="n">AccountModel</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>  <span class="c1"># {&quot;balance&quot;: float, &quot;transaction_count&quot;: int}</span>

    <span class="c1"># Initial state generator</span>
    <span class="n">initial_gen</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">dict</span><span class="p">(</span>
        <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="s2">&quot;balance&quot;</span><span class="p">),</span>
        <span class="n">Gen</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">),</span>
        <span class="n">min_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">max_size</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">{</span><span class="o">**</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;transactions&quot;</span><span class="p">:</span> <span class="p">[]})</span>

    <span class="c1"># Model factory</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">model_factory</span><span class="p">(</span><span class="n">account</span><span class="p">:</span> <span class="n">BankAccount</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AccountModel</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">],</span>
            <span class="s2">&quot;transaction_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s2">&quot;transactions&quot;</span><span class="p">])</span>
        <span class="p">}</span>

    <span class="c1"># Action: Deposit money</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deposit_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">amount</span><span class="p">:</span>
            <span class="n">Action</span><span class="p">(</span><span class="k">lambda</span> <span class="n">account</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">account</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">amount</span><span class="p">,</span>
                    <span class="s2">&quot;transactions&quot;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;transactions&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">amount</span><span class="p">]</span>
                <span class="p">}),</span>
                <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">amount</span><span class="p">,</span>
                    <span class="s2">&quot;transaction_count&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;transaction_count&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">})</span>
            <span class="p">))</span>
        <span class="p">)</span>

    <span class="c1"># Action: Withdraw money</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">withdraw_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">min_value</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="mf">100.0</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">amount</span><span class="p">:</span>
            <span class="n">Action</span><span class="p">(</span><span class="k">lambda</span> <span class="n">account</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">account</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">amount</span><span class="p">),</span>
                    <span class="s2">&quot;transactions&quot;</span><span class="p">:</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;transactions&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">amount</span><span class="p">]</span>
                <span class="p">}),</span>
                <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s2">&quot;balance&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">amount</span><span class="p">),</span>
                    <span class="s2">&quot;transaction_count&quot;</span><span class="p">:</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;transaction_count&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="p">})</span>
            <span class="p">))</span>
        <span class="p">)</span>

    <span class="c1"># Action generator factory</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">action_factory</span><span class="p">(</span><span class="n">account</span><span class="p">:</span> <span class="n">BankAccount</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">AccountModel</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">deposit_action</span><span class="p">(),</span> <span class="n">withdraw_action</span><span class="p">())</span>

    <span class="c1"># Create the property</span>
    <span class="n">prop</span> <span class="o">=</span> <span class="n">stateful_property</span><span class="p">(</span><span class="n">initial_gen</span><span class="p">,</span> <span class="n">model_factory</span><span class="p">,</span> <span class="n">action_factory</span><span class="p">)</span>

    <span class="c1"># Add post-check to verify model consistency</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">post_check</span><span class="p">(</span><span class="n">account</span><span class="p">:</span> <span class="n">BankAccount</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">AccountModel</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">account</span><span class="p">[</span><span class="s2">&quot;transactions&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="n">model</span><span class="p">[</span><span class="s2">&quot;transaction_count&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="n">account</span><span class="p">[</span><span class="s2">&quot;balance&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span>

    <span class="n">prop</span><span class="o">.</span><span class="n">set_post_check</span><span class="p">(</span><span class="n">post_check</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
</code></pre></div>
<h2 id="shrinking-in-stateful-testing">Shrinking in Stateful Testing<a class="headerlink" href="#shrinking-in-stateful-testing" title="Permanent link">&para;</a></h2>
<p>If a test sequence fails (an action throws an error or the <code>post_check</code> fails), <code>python-proptest</code> automatically tries to <strong>shrink</strong> the test case to find a minimal reproduction. It does this by:</p>
<ol>
<li><strong>Shrinking the Action Sequence</strong>: Trying shorter sequences or simpler actions.</li>
<li><strong>Shrinking the Initial State</strong>: Trying simpler versions of the initial state generated by <code>initial_gen</code>.</li>
</ol>
<p>The goal is to present the simplest possible initial state and sequence of actions that trigger the failure, making debugging easier. The error message will report the shrunk arguments if successful.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">python_proptest</span><span class="w"> </span><span class="kn">import</span> <span class="n">simple_stateful_property</span><span class="p">,</span> <span class="n">Gen</span><span class="p">,</span> <span class="n">SimpleAction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">test_failing_stateful_property</span><span class="p">():</span>
    <span class="c1"># This will demonstrate shrinking in action</span>
    <span class="n">Counter</span> <span class="o">=</span> <span class="nb">int</span>

    <span class="n">initial_gen</span> <span class="o">=</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">increment_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">counter</span><span class="p">:</span> <span class="n">counter</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decrement_action</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">just</span><span class="p">(</span><span class="n">SimpleAction</span><span class="p">(</span><span class="k">lambda</span> <span class="n">counter</span><span class="p">:</span> <span class="n">counter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">action_factory</span><span class="p">(</span><span class="n">counter</span><span class="p">:</span> <span class="n">Counter</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Gen</span><span class="o">.</span><span class="n">one_of</span><span class="p">(</span><span class="n">increment_action</span><span class="p">(),</span> <span class="n">decrement_action</span><span class="p">())</span>

    <span class="n">prop</span> <span class="o">=</span> <span class="n">simple_stateful_property</span><span class="p">(</span><span class="n">initial_gen</span><span class="p">,</span> <span class="n">action_factory</span><span class="p">)</span>

    <span class="c1"># This will fail and show shrinking in action</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">set_post_check_without_model</span><span class="p">(</span><span class="k">lambda</span> <span class="n">counter</span><span class="p">:</span> <span class="n">counter</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">prop</span><span class="o">.</span><span class="n">go</span><span class="p">()</span>
</code></pre></div>
<p>Stateful testing is particularly powerful for testing systems with complex state transitions, concurrent operations, or systems where the order of operations matters. It helps uncover race conditions, state inconsistencies, and other subtle bugs that are difficult to find with traditional unit tests.</p>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="October 27, 2025 09:19:56 UTC">October 27, 2025</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tracking", "navigation.tabs.sticky", "navigation.indexes", "navigation.path", "toc.follow", "navigation.top", "search.highlight", "search.suggest", "navigation.expand"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>